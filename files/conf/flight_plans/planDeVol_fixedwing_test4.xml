<!DOCTYPE flight_plan SYSTEM "flight_plan.dtd">
                <flight_plan alt="219.3" ground_alt="189.3" lat0="43.4486818072924" 
                lon0="1.264629364013672" name="ProcedureFixedWing" max_dist_from_home="68000" security_height="2" geofence_sector="Contingency">
                <header> #include "autopilot.h" 
                #include "subsystems/datalink/datalink.h"
                #include "subsystems/electrical.h"
                #include "subsystems/radio_control.h"
                </header>
                <waypoints>
                <waypoint name="P10" lon="1.265830993652344" lat="43.44818330704061"/>
    <waypoint name="R10" lon="1.1089324951171877" lat="43.549045783240295"/>
    <waypoint name="R11" lon="1.1089324951171877" lat="43.549045783240295"/>
    <waypoint name="R21" lon="0.9297180175781251" lat="43.49079023700749"/>
    <waypoint name="R22" lon="0.9297180175781251" lat="43.49079023700749"/>
    <waypoint name="R32" lon="1.197509765625" lat="43.7572088788494"/>
    <waypoint name="R33" lon="1.197509765625" lat="43.7572088788494"/>
    <waypoint name="R43" lon="1.6053771972656252" lat="43.843441641085036"/>
    <waypoint name="R44" lon="1.6053771972656252" lat="43.843441641085036"/>
    <waypoint name="R54" lon="1.8292236328125002" lat="43.52664646047308"/>
    <waypoint name="R55" lon="1.8292236328125002" lat="43.52664646047308"/>
    <waypoint name="R65" lon="2.0709228515625004" lat="43.61221676817573"/>
    <waypoint name="R56" lon="1.8292236328125002" lat="43.52664646047308"/>
    <waypoint name="P26" lon="1.264629364013672" lat="43.4486818072924"/>
    <waypoint name="R67" lon="2.0709228515625004" lat="43.61221676817573"/>
    <waypoint name="P27" lon="1.264629364013672" lat="43.4486818072924"/>
    <waypoint name="HOME" lon="1.264629364013672" lat="43.4486818072924"/>
    <waypoint name="STDBY" lon="1.265129364013672" lat="43.449181807292405"/>
    <waypoint name="CLIMB" lon="1.265129364013672" lat="43.449181807292405"/>
    <waypoint name="_BASELEG" lon="1.265129364013672" lat="43.44818330704061"/>
    <waypoint name="_C_0" lon="0.9272387923611781" lat="43.49079021022528"/>
    <waypoint name="_C_1" lon="0.9274034367404415" lat="43.49017278032648"/>
    <waypoint name="_C_2" lon="0.9274034367404415" lat="43.48911105779059"/>
    <waypoint name="_C_3" lon="0.9288668840143318" lat="43.48911105779059"/>
    <waypoint name="_C_4" lon="0.9297180175781249" lat="43.488991596280044"/>
    <waypoint name="_C_5" lon="0.930569151141918" lat="43.48911105779059"/>
    <waypoint name="_C_6" lon="1.1112492623362935" lat="43.48911105779059"/>
    <waypoint name="_C_7" lon="1.1112492623362935" lat="43.54515237827428"/>
    <waypoint name="_C_8" lon="1.2623388591614675" lat="43.44802588038453"/>
    <waypoint name="_C_9" lon="1.262625060593491" lat="43.44762457529566"/>
    <waypoint name="_C_10" lon="1.2631731619193542" lat="43.44722666713801"/>
    <waypoint name="_C_11" lon="1.2640170325492153" lat="43.44694708272124"/>
    <waypoint name="_C_12" lon="1.264374803558756" lat="43.44672816688638"/>
    <waypoint name="_C_13" lon="1.2650654324482984" lat="43.44647269550273"/>
    <waypoint name="_C_14" lon="1.265830993652344" lat="43.44638466631316"/>
    <waypoint name="_C_15" lon="1.2665965548563893" lat="43.44647269550273"/>
    <waypoint name="_C_16" lon="1.2672871837459319" lat="43.44672816688638"/>
    <waypoint name="_C_17" lon="1.267835280554599" lat="43.44712607504416"/>
    <waypoint name="_C_18" lon="1.2679655090699564" lat="43.4473116214274"/>
    <waypoint name="_C_19" lon="1.8300171507388678" lat="43.52494580941222"/>
    <waypoint name="_C_20" lon="2.07327170985297" lat="43.52494580941222"/>
    <waypoint name="_C_21" lon="2.07327170985297" lat="43.6116413837317"/>
    <waypoint name="_C_22" lon="2.073407076855726" lat="43.61221674127961"/>
    <waypoint name="_C_23" lon="2.07327170985297" lat="43.612792168041544"/>
    <waypoint name="_C_24" lon="2.07327170985297" lat="43.613917413543405"/>
    <waypoint name="_C_25" lon="2.071717542412394" lat="43.613917413543405"/>
    <waypoint name="_C_26" lon="2.0709228515625004" lat="43.61401540890317"/>
    <waypoint name="_C_27" lon="2.070098891355068" lat="43.613917413543405"/>
    <waypoint name="_C_28" lon="1.82687806358424" lat="43.613917413543405"/>
    <waypoint name="_C_29" lon="1.82687806358424" lat="43.56458649984987"/>
    <waypoint name="_C_30" lon="1.807920730902307" lat="43.56074150618315"/>
    <waypoint name="_C_31" lon="1.6075583214666485" lat="43.84426734189409"/>
    <waypoint name="_C_32" lon="1.6075583214666485" lat="43.84517060346097"/>
    <waypoint name="_C_33" lon="1.6059871667314176" lat="43.84517060346097"/>
    <waypoint name="_C_34" lon="1.6053771972656252" lat="43.84524028181249"/>
    <waypoint name="_C_35" lon="1.6047672277998366" lat="43.84517060346097"/>
    <waypoint name="_C_36" lon="1.1953317236023815" lat="43.84517060346097"/>
    <waypoint name="_C_37" lon="1.1953317236023815" lat="43.75810354544435"/>
    <waypoint name="_C_38" lon="0.9868912512104606" lat="43.55072495557103"/>
    <waypoint name="_C_39" lon="0.9274034367404415" lat="43.55072495557103"/>
    <waypoint name="_C_40" lon="0.9274034367404415" lat="43.491407713373256"/>
    <waypoint name="_C_0" lon="0.993032056768246" lat="43.55072495557103"/>
    <waypoint name="_C_1" lon="1.1988491551716371" lat="43.75547991235959"/>
    <waypoint name="_C_2" lon="1.6075583214666485" lat="43.75547991235959"/>
    <waypoint name="_C_3" lon="1.6075583214666485" lat="43.836393938402566"/>
    <waypoint name="_C_4" lon="1.8030427334097643" lat="43.55975213337529"/>
    <waypoint name="_C_5" lon="1.2655859180090978" lat="43.450743229748355"/>
    <waypoint name="_C_6" lon="1.1112492623362935" lat="43.54996057345269"/>
    <waypoint name="_C_7" lon="1.1112492623362935" lat="43.55072495557103"/>
    <waypoint name="_C_8" lon="1.1097844979818217" lat="43.55072495557103"/>
    <waypoint name="_C_9" lon="1.1089324951171875" lat="43.550844423967746"/>
    <waypoint name="_C_10" lon="1.108080492252555" lat="43.55072495557103"/>
    <waypoint name="_C_0" lon="1.3217608195218087" lat="43.45840195601586"/>
    <waypoint name="_C_1" lon="1.8053513413628244" lat="43.556485082745084"/>
    <waypoint name="_C_2" lon="1.8255053273627868" lat="43.52796395919306"/>
    <waypoint name="_C_0" lon="1.8102291303592712" lat="43.557474408992576"/>
    <waypoint name="_C_1" lon="1.82687806358424" lat="43.560851190285135"/>
    <waypoint name="_C_2" lon="1.82687806358424" lat="43.53391103359787"/>
    <waypoint name="_G_0" lon="0.9295940563172411" lat="43.49079023694053"/>
    <waypoint name="_G_1" lon="0.9296022897095652" lat="43.49070627821002"/>
    <waypoint name="_G_2" lon="0.9297180175781249" lat="43.490700304971114"/>
    <waypoint name="_G_3" lon="1.1090483346550184" lat="43.49070627821002"/>
    <waypoint name="_G_4" lon="1.1090483346550184" lat="43.54885110953659"/>
    <waypoint name="_G_5" lon="1.2628982284203154" lat="43.44994852163705"/>
    <waypoint name="_G_6" lon="1.26237572419973" lat="43.449428967525385"/>
    <waypoint name="_G_7" lon="1.2621770724215984" lat="43.448937754355306"/>
    <waypoint name="_G_8" lon="1.2621770931775746" lat="43.44842580782714"/>
    <waypoint name="_G_9" lon="1.2623757798777826" lat="43.44793460280379"/>
    <waypoint name="_G_10" lon="1.2627570319785975" lat="43.44750393283157"/>
    <waypoint name="_G_11" lon="1.26328996066367" lat="43.44716868660969"/>
    <waypoint name="_G_12" lon="1.2639313919191717" lat="43.44695602202978"/>
    <waypoint name="_G_13" lon="1.264629364013672" lat="43.44688316656496"/>
    <waypoint name="_G_14" lon="1.2653273361081725" lat="43.44695602202978"/>
    <waypoint name="_G_15" lon="1.265968767363674" lat="43.44716868660969"/>
    <waypoint name="_G_16" lon="1.2665016960487467" lat="43.44750393283157"/>
    <waypoint name="_G_17" lon="1.2668829481495614" lat="43.44793460280379"/>
    <waypoint name="_G_18" lon="1.2670816348497695" lat="43.44842580782714"/>
    <waypoint name="_G_19" lon="1.2670816552467514" lat="43.44892889975526"/>
    <waypoint name="_G_20" lon="1.829263309768846" lat="43.52656142805504"/>
    <waypoint name="_G_21" lon="2.0710402955633946" lat="43.52656142805504"/>
    <waypoint name="_G_22" lon="2.0710402955633946" lat="43.61230180057953"/>
    <waypoint name="_G_23" lon="1.8291063554326445" lat="43.61230180057953"/>
    <waypoint name="_G_24" lon="1.8291063554326445" lat="43.563264174725816"/>
    <waypoint name="_G_25" lon="1.806700217312033" lat="43.558719691391545"/>
    <waypoint name="_G_26" lon="1.605486254990052" lat="43.8435280893017"/>
    <waypoint name="_G_27" lon="1.1974008650315247" lat="43.8435280893017"/>
    <waypoint name="_G_28" lon="1.1974008650315247" lat="43.75725361309423"/>
    <waypoint name="_G_29" lon="0.9882046835839281" lat="43.549129742020554"/>
    <waypoint name="_G_30" lon="0.9296022897095652" lat="43.549129742020554"/>
    <waypoint name="_G_0" lon="0.9885117185277114" lat="43.549129742020554"/>
    <waypoint name="_G_1" lon="1.1975767371133037" lat="43.75712243062247"/>
    <waypoint name="_G_2" lon="1.605486254990052" lat="43.75712243062247"/>
    <waypoint name="_G_3" lon="1.605486254990052" lat="43.843089237311226"/>
    <waypoint name="_G_4" lon="1.8064563223892023" lat="43.55867022385697"/>
    <waypoint name="_G_5" lon="1.2669565210133333" lat="43.44924717901993"/>
    <waypoint name="_G_6" lon="1.2665017689714873" lat="43.44985965120453"/>
    <waypoint name="_G_7" lon="1.265968834378648" lat="43.45019491234167"/>
    <waypoint name="_G_8" lon="1.2653273759385992" lat="43.450407588309695"/>
    <waypoint name="_G_9" lon="1.264629364013672" lat="43.45048044801985"/>
    <waypoint name="_G_10" lon="1.2639313520887447" lat="43.450407588309695"/>
    <waypoint name="_G_11" lon="1.2630871037316291" lat="43.450067340254755"/>
    <waypoint name="_G_12" lon="1.1090483346550184" lat="43.549129742020554"/>
    <waypoint name="_G_0" lon="1.2674859130670135" lat="43.449167810999924"/>
    <waypoint name="_G_1" lon="1.8065717478352479" lat="43.5585068702197"/>
    <waypoint name="_G_2" lon="1.8290377203218633" lat="43.526712335771734"/>
    <waypoint name="_G_0" lon="1.8068156422368384" lat="43.558556337637874"/>
    <waypoint name="_G_1" lon="1.8291063554326445" lat="43.56307740915001"/>
    <waypoint name="_G_2" lon="1.8291063554326445" lat="43.52700967058438"/>
    </waypoints>
            <sectors>
            <sector name="GreenZone" color="green">
    <corner name="_G_30"/>
        <corner name="_G_29"/>
        <corner name="_G_28"/>
        <corner name="_G_27"/>
        <corner name="_G_26"/>
        <corner name="_G_25"/>
        <corner name="_G_24"/>
        <corner name="_G_23"/>
        <corner name="_G_22"/>
        <corner name="_G_21"/>
        <corner name="_G_20"/>
        <corner name="_G_19"/>
        <corner name="_G_18"/>
        <corner name="_G_17"/>
        <corner name="_G_16"/>
        <corner name="_G_15"/>
        <corner name="_G_14"/>
        <corner name="_G_13"/>
        <corner name="_G_12"/>
        <corner name="_G_11"/>
        <corner name="_G_10"/>
        <corner name="_G_9"/>
        <corner name="_G_8"/>
        <corner name="_G_7"/>
        <corner name="_G_6"/>
        <corner name="_G_5"/>
        <corner name="_G_4"/>
        <corner name="_G_3"/>
        <corner name="_G_2"/>
        <corner name="_G_1"/>
        <corner name="_G_0"/>
        </sector>
    <sector name="Contingency" color="orange">
    <corner name="_C_40"/>
        <corner name="_C_39"/>
        <corner name="_C_38"/>
        <corner name="_C_37"/>
        <corner name="_C_36"/>
        <corner name="_C_35"/>
        <corner name="_C_34"/>
        <corner name="_C_33"/>
        <corner name="_C_32"/>
        <corner name="_C_31"/>
        <corner name="_C_30"/>
        <corner name="_C_29"/>
        <corner name="_C_28"/>
        <corner name="_C_27"/>
        <corner name="_C_26"/>
        <corner name="_C_25"/>
        <corner name="_C_24"/>
        <corner name="_C_23"/>
        <corner name="_C_22"/>
        <corner name="_C_21"/>
        <corner name="_C_20"/>
        <corner name="_C_19"/>
        <corner name="_C_18"/>
        <corner name="_C_17"/>
        <corner name="_C_16"/>
        <corner name="_C_15"/>
        <corner name="_C_14"/>
        <corner name="_C_13"/>
        <corner name="_C_12"/>
        <corner name="_C_11"/>
        <corner name="_C_10"/>
        <corner name="_C_9"/>
        <corner name="_C_8"/>
        <corner name="_C_7"/>
        <corner name="_C_6"/>
        <corner name="_C_5"/>
        <corner name="_C_4"/>
        <corner name="_C_3"/>
        <corner name="_C_2"/>
        <corner name="_C_1"/>
        <corner name="_C_0"/>
        </sector>
    </sectors>
                <exceptions>
                <!-- RC loss AND DL loss AND GPS loss -->
                <exception cond="((radio_control.status == RC_REALLY_LOST) @AND datalink_time > 10 @AND GpsIsLost() @AND
                  !(IndexOfBlock('Takeoff') > nav_block) @AND
                  !(nav_block >= IndexOfBlock('Land Right')))" deroute="EmergencyKill"/>
    
                <!-- RC loss -->
                <exception cond="((radio_control.status == RC_REALLY_LOST) @AND
                  (radio_control.time_since_last_frame > 60) @AND
                  !(IndexOfBlock('Takeoff') > nav_block) @AND
                  !(nav_block >= IndexOfBlock('Land Right')))" deroute="EmergencyLanding"/>
    
                <!-- Battery low -->
                <exception cond="(electrical.bat_low @AND
                  !(IndexOfBlock('Takeoff') > nav_block) @AND
                  !(nav_block >= IndexOfBlock('Land Right')))" deroute="EmergencyLanding"/>
                
                <!-- GPS loss -->
                <exception cond="(GpsIsLost() @AND
                  !(IndexOfBlock('Takeoff') > nav_block) @AND
                  !(nav_block >= IndexOfBlock('Land Right')))" deroute="EmergencyLanding"/>
            
                <!-- DL loss -->
                <exception cond="(datalink_time > 10 @AND
                  !(IndexOfBlock('Takeoff') > nav_block) @AND
                  !(nav_block >= IndexOfBlock('Land Right')))" deroute="EmergencyLanding"/>
            
                <!-- Outside Green Zone 
                <exception cond="(!InsideGreenZone(GetPosX(), GetPosY()) @AND
                  !(IndexOfBlock('Takeoff') > nav_block) @AND
                  !(nav_block >= IndexOfBlock('Land Right')))" deroute="EmergencyLanding"/> -->
                </exceptions>
                <blocks>
                    <block name="Wait GPS">
                        <set value="1" var="autopilot.kill_throttle"/>
                        <while cond="!GpsFixValid()"/>
                    </block>
                    <block name="Geo init">
                        <while cond="LessThan(NavBlockTime(), 10)"/>
                        <call_once fun="NavSetGroundReferenceHere()"/>
                        <call_once fun="NavSetWaypointHere(WP_STDBY)"/>
                    </block>
                    <block name="Holding point">
                        <set value="1" var="autopilot.kill_throttle"/>
                        <attitude pitch="0" roll="0" throttle="0" vmode="throttle" until="FALSE"/>
                        
                    </block>
                    <block name="Takeoff" strip_button="Takeoff" strip_icon="takeoff.png">
                        <exception cond="GetPosAlt() > GetAltRef()+25" deroute="Standby"/>
                        <set value="0" var="autopilot.kill_throttle"/>
                          <set value="0" var="autopilot.flight_time"/>
                        <go from="HOME" throttle="1.0" vmode="throttle" wp="CLIMB" pitch="15"/>
                    </block>
                    <block name="Standby" strip_button="Standby" strip_icon="home.png">
                        <circle radius="nav_radius" wp="STDBY"/>
                    </block>
                    <block name="Go To R10">
                            <go from="P10" wp="R10" hmode="route"/>
                            <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Survey 1">
                            <survey_rectangle wp1="R11" wp2="R21" grid="400" orientation="NS"/>
                        <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Go To R32">
                            <go from="R22" wp="R32" hmode="route"/>
                            <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Survey 3">
                            <survey_rectangle wp1="R33" wp2="R43" grid="400" orientation="NS"/>
                        <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Go To R54">
                            <go from="R44" wp="R54" hmode="route"/>
                            <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Survey 5">
                            <survey_rectangle wp1="R55" wp2="R65" grid="400" orientation="NS"/>
                        <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Go To P26">
                            <go from="R56" wp="P26" hmode="route"/>
                            <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Go To P27">
                            <go from="R67" wp="P27" hmode="route"/>
                            <exception cond="(GetPosAlt() > GetAltRef() + 200)" deroute="EmergencyLanding"/>
    </block>
                        <block name="Standby_End">
                    <call_once fun="NavSetWaypointHere(WP_STDBY)"/>
                    <circle radius="nav_radius" wp="STDBY"/>
                </block>
                <block name="Land Right" strip_button="Land right" strip_icon="land-right.png" group="land">
                    <set value="DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
                    <deroute block="land"/>
                </block>
                    <block name="Land Left" strip_button="Land left" strip_icon="land-left.png" group="land">
                    <set value="-DEFAULT_CIRCLE_RADIUS" var="nav_radius"/>
                    <deroute block="land"/>
                </block>
                <block name="land">
                    <call_once fun="nav_compute_baseleg(WP_CLIMB, WP_HOME, WP__BASELEG, nav_radius)"/>
                    <circle radius="nav_radius" until="NavCircleCount() > 0.5" wp="_BASELEG"/>
                    <circle radius="nav_radius" until="NavQdrCloseTo(DegOfRad(baseleg_out_qdr)-(nav_radius/fabs(nav_radius))*10) @AND (fabs(GetPosAlt() - WaypointAlt(WP__BASELEG)) @LT 10)" wp="_BASELEG"/>
                </block>
                <block name="final">
                    <exception cond="GetAltRef() + 10 > GetPosAlt()" deroute="flare"/>
                    <go from="CLIMB" hmode="route" vmode="glide" wp="HOME"/>
                </block>
                <block name="flare">
                    <go approaching_time="0" from="CLIMB" hmode="route" throttle="0.0" vmode="throttle" wp="HOME"/>
                    <attitude roll="0.0" throttle="0.0" until="FALSE" vmode="throttle"/>
                </block>
                <block name="EmergencyKill">
                    <call_once fun="NavKillThrottle()"/>
                </block>
                <block name="EmergencyLanding" pre_call="if (!InsideContingency(GetPosX(), GetPosY())) NavKillThrottle();">
                    <call_once fun="NavSetWaypointHere(WP_STDBY)"/>
                    <circle radius="nav_radius" wp="STDBY" vmode="throttle" throttle="0"/>
                    <exception cond="GetAltRef() + 5 > GetPosAlt()" deroute="flare"/>
                </block>
            </blocks>
        </flight_plan>
        
